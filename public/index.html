<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>วางแผนการเดินทาง</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* คง CSS เดิมไว้ */
  </style>
</head>
<body>
  <div class="form-container">
    <h2>วางแผนการเดินทาง</h2>
    <form id="travel-form">
      <input type="hidden" name="userId" id="userId" value="">
      <div class="form-group">
        <i class="fas fa-map-marker-alt"></i>
        <label for="startLocation">จุดเริ่มต้น:</label>
        <input type="text" id="startLocation" name="startLocation" placeholder="เช่น กรุงเทพมหานคร, เชียงใหม่" required aria-label="จุดเริ่มต้นของการเดินทาง">
      </div>
      <div class="form-group">
        <i class="fas fa-map-pin"></i>
        <label for="destination">ปลายทาง:</label>
        <input type="text" id="destination" name="destination" placeholder="เช่น เชียงราย, เชียงใหม่" required aria-label="ปลายทางของการเดินทาง">
      </div>
      <div class="form-group">
        <i class="fas fa-calendar-alt"></i>
        <label for="arrivalDate">วันที่เดินทางไป:</label>
        <input type="date" id="arrivalDate" name="arrivalDate" required aria-label="วันที่เดินทางไป">
      </div>
      <div class="form-group">
        <i class="fas fa-calendar-alt"></i>
        <label for="returnDate">วันที่เดินทางกลับ:</label>
        <input type="date" id="returnDate" name="returnDate" required aria-label="วันที่เดินทางกลับ">
      </div>
      <div class="form-group">
        <i class="fas fa-wallet"></i>
        <label for="budget">งบประมาณ (บาท):</label>
        <input type="number" id="budget" name="budget" placeholder="เช่น 2000" required aria-label="งบประมาณสำหรับการเดินทาง (บาท)">
      </div>
      <div class="form-group">
        <label>ความชอบ (เลือกได้มากกว่า 1):</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="preference" value="ธรรมชาติ"> ธรรมชาติ</label>
          <label><input type="checkbox" name="preference" value="วัฒนธรรม"> วัฒนธรรม</label>
          <label><input type="checkbox" name="preference" value="ผจญภัย"> ผจญภัย</label>
          <label><input type="checkbox" name="preference" value="ช้อปปิ้ง"> ช้อปปิ้ง</label>
        </div>
      </div>
      <div class="form-group">
        <i class="fas fa-users"></i>
        <label for="travelWith">เดินทางกับใคร:</label>
        <select id="travelWith" name="travelWith" required aria-label="เลือกผู้ที่เดินทางด้วย">
          <option value="" disabled selected>เลือกผู้ที่เดินทางด้วย</option>
          <option value="ครอบครัว">ครอบครัว</option>
          <option value="เพื่อน">เพื่อน</option>
          <option value="คู่รัก">คู่รัก</option>
          <option value="เดี่ยว">คนเดียว</option>
        </select>
      </div>
      <div class="form-group">
        <i class="fas fa-car"></i>
        <label for="transport">วิธีการเดินทาง:</label>
        <select id="transport" name="transport" required aria-label="เลือกวิธีการเดินทาง">
          <option value="" disabled selected>เลือกวิธีการเดินทาง</option>
          <option value="รถยนต์">รถยนต์</option>
          <option value="รถไฟ">รถไฟ</option>
          <option value="เครื่องบิน">เครื่องบิน</option>
          <option value="รถบัส">รถบัส</option>
        </select>
      </div>
      <button type="submit">ส่งข้อมูล</button>
    </form>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>กำลังโหลด...</p>
    </div>
  </div>

  <div class="popup" id="popup">
    <p id="popupMessage"></p>
    <button onclick="closePopup()">ตกลง</button>
  </div>

  <script>
    let userProfile = null;

    liff.init({ liffId: "2006885303-nA7agEQN" })
      .then(() => {
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          return liff.getProfile();
        }
      })
      .then(profile => {
        if (profile && profile.userId) {
          userProfile = profile;
          document.getElementById("userId").value = profile.userId; // เก็บค่าใน hidden input (เผื่อใช้)
        } else {
          showPopup("ไม่พบ User ID กรุณาเข้าสู่ระบบผ่าน LINE ก่อน");
          document.getElementById("travel-form").querySelector("button").disabled = true;
        }
      })
      .catch(err => {
        console.error("LIFF init error", err);
        showPopup("เกิดข้อผิดพลาดในการเชื่อมต่อกับ LINE");
        document.getElementById("travel-form").querySelector("button").disabled = true;
      });

    const arrivalDateInput = document.getElementById("arrivalDate");
    const returnDateInput = document.getElementById("returnDate");
    const budgetInput = document.getElementById("budget");
    const today = new Date().toISOString().split("T")[0];
    arrivalDateInput.setAttribute("min", today);
    returnDateInput.setAttribute("min", today);
    arrivalDateInput.addEventListener("change", () => {
      returnDateInput.setAttribute("min", arrivalDateInput.value);
    });

    const showLoading = () => {
      document.getElementById("loadingOverlay").style.display = "flex";
    };
    const hideLoading = () => {
      document.getElementById("loadingOverlay").style.display = "none";
    };
    const showPopup = (message) => {
      document.getElementById("popupMessage").textContent = message;
      document.getElementById("popup").style.display = "block";
    };
    const closePopup = () => {
      document.getElementById("popup").style.display = "none";
    };
    const resetForm = () => {
      document.getElementById("travel-form").reset();
      arrivalDateInput.setAttribute("min", today);
      returnDateInput.setAttribute("min", today);
    };

    document.getElementById("travel-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const submitButton = e.target.querySelector("button");
      submitButton.disabled = true;

      const arrivalDate = new Date(arrivalDateInput.value);
      const returnDate = new Date(returnDateInput.value);
      const budget = parseInt(budgetInput.value);

      if (arrivalDate < new Date(today)) {
        showPopup("วันที่เดินทางไปต้องไม่เป็นอดีต");
        submitButton.disabled = false;
        return;
      }
      if (returnDate < arrivalDate) {
        showPopup("วันที่เดินทางกลับต้องมากกว่าหรือเท่ากับวันที่เดินทางไป");
        submitButton.disabled = false;
        return;
      }
      if (budget <= 0) {
        showPopup("งบประมาณต้องมากกว่า 0 บาท");
        submitButton.disabled = false;
        return;
      }

      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      if (!data.startLocation.trim() || !data.destination.trim()) {
        showPopup("กรุณากรอกจุดเริ่มต้นและปลายทางให้ครบถ้วน");
        submitButton.disabled = false;
        return;
      }

      const preferences = document.querySelectorAll('input[name="preference"]:checked');
      data.preference = preferences.length > 0 
        ? Array.from(preferences).map(pref => pref.value).join(", ") 
        : "ทั่วไป";

      showLoading();

      const payload = {
        userId: userProfile.userId, // ดึงจาก LIFF โดยตรง
        startLocation: data.startLocation,
        destination: data.destination,
        budget: data.budget,
        preference: data.preference,
        travelWith: data.travelWith,
        transport: data.transport,
        travelDateStart: data.arrivalDate,
        travelDateEnd: data.returnDate,
      };

      try {
        const response = await fetch("https://tripster-bot.onrender.com/submit-travel-plan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          signal: AbortSignal.timeout(30000), // Timeout 30 วินาที
        });

        hideLoading();
        if (response.ok) {
          showPopup("ข้อมูลถูกส่งเรียบร้อยแล้ว! กรุณาตรวจสอบผลลัพธ์ใน LINE");
          resetForm();
        } else {
          const errorData = await response.json();
          showPopup(`เกิดข้อผิดพลาด: ${errorData.error || response.statusText || "กรุณาลองใหม่"}`);
        }
      } catch (error) {
        hideLoading();
        showPopup(`เกิดข้อผิดพลาด: ${error.message || "ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้"}`);
      } finally {
        submitButton.disabled = false;
      }
    });
  </script>
</body>
</html>